<header class="header">
    <div class="container">
        <div class="nav-container">
            <div class="logo">
                <a href="{{ '/' | relative_url }}">
                    {% if site.logo %}
                        <img src="{{ site.logo | relative_url }}" alt="{{ site.title }} Logo">
                    {% endif %}
                    <span>{{ site.title_short | default: site.title }}</span>
                </a>
            </div>
            
            <nav class="nav">
                <!-- Search Icon -->
                <button class="search-toggle" id="searchToggle" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </button>

                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>

                <!-- Main Navigation Menu -->
                <ul class="nav-menu" id="mainNav">
                    {% for link in site.navigation %}
                    {% assign link_url = link.url | relative_url %}
                    {% assign page_url = page.url | relative_url %}
                    
                    {% if link.dropdown %}
                    <li class="nav-item dropdown" data-dropdown="{{ link.title | slugify }}">
                        {% comment %} Check if any dropdown item is active {% endcomment %}
                        {% assign dropdown_active = false %}
                        {% for sublink in link.dropdown %}
                            {% assign sublink_url = sublink.url | relative_url %}
                            {% if page_url == sublink_url %}
                                {% assign dropdown_active = true %}
                            {% endif %}
                            {% comment %} Check nested dropdowns too {% endcomment %}
                            {% if sublink.dropdown %}
                                {% for subsublink in sublink.dropdown %}
                                    {% assign subsublink_url = subsublink.url | relative_url %}
                                    {% if page_url == subsublink_url %}
                                        {% assign dropdown_active = true %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        
                        <a href="javascript:void(0)" class="nav-link dropdown-trigger {% if dropdown_active %}active{% endif %}" 
                           data-target="{{ link.title | slugify }}">
                            {{ link.title }} <span class="dropdown-arrow">▼</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a href="{{ link_url }}" class="nav-link {% if page_url == link_url %}active{% endif %}">
                            {{ link.title }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>

                <!-- Dropdown Navigation Menus -->
                {% for link in site.navigation %}
                    {% if link.dropdown %}
                    <ul class="nav-menu dropdown-menu" id="dropdown-{{ link.title | slugify }}" style="display: none;">
                        <li class="nav-item breadcrumb-item">
                            <button class="nav-link breadcrumb-link back-to-main" data-back="main">
                                ← {{ link.title }}
                            </button>
                        </li>
                        
                        {% for sublink in link.dropdown %}
                            {% assign sublink_url = sublink.url | relative_url %}
                            
                            {% if sublink.dropdown %}
                                {% comment %} Nested dropdown item {% endcomment %}
                                <li class="nav-item dropdown" data-dropdown="{{ link.title | slugify }}-{{ sublink.title | slugify }}">
                                    <a href="javascript:void(0)" class="nav-link dropdown-trigger {% if page_url == sublink_url %}active{% endif %}" 
                                       data-target="{{ link.title | slugify }}-{{ sublink.title | slugify }}">
                                        {{ sublink.title }} <span class="dropdown-arrow">▶</span>
                                    </a>
                                </li>
                            {% else %}
                                {% comment %} Regular dropdown item {% endcomment %}
                                <li class="nav-item">
                                    <a href="{{ sublink_url }}" class="nav-link {% if page_url == sublink_url %}active{% endif %}">
                                        {{ sublink.title }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    {% endif %}
                {% endfor %}

                <!-- Nested Dropdown Menus -->
                {% for link in site.navigation %}
                    {% if link.dropdown %}
                        {% for sublink in link.dropdown %}
                            {% if sublink.dropdown %}
                            <ul class="nav-menu dropdown-menu" id="dropdown-{{ link.title | slugify }}-{{ sublink.title | slugify }}" style="display: none;">
                                <li class="nav-item breadcrumb-item">
                                    <button class="nav-link breadcrumb-link back-to-main" data-back="{{ link.title | slugify }}">
                                        ← {{ sublink.title }}
                                    </button>
                                </li>
                                
                                {% for subsublink in sublink.dropdown %}
                                    {% assign subsublink_url = subsublink.url | relative_url %}
                                    <li class="nav-item">
                                        <a href="{{ subsublink_url }}" class="nav-link {% if page_url == subsublink_url %}active{% endif %}">
                                            {{ subsublink.title }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-modal">
            <div class="search-header">
                <div class="search-input-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off">
                    <button class="search-close" id="searchClose" aria-label="Close search">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-placeholder">
                    <p>Type here to search</p>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Navigation state management
    let currentNavLevel = 'main';
    const navHistory = ['main'];

    // Navigation functions
    function showNav(level) {
        // Hide all nav menus
        document.querySelectorAll('.nav-menu').forEach(menu => {
            menu.style.display = 'none';
        });
        
        // Show the requested nav menu
        const targetNav = document.getElementById(level === 'main' ? 'mainNav' : `dropdown-${level}`);
        if (targetNav) {
            targetNav.style.display = 'flex';
            currentNavLevel = level;
        }
    }

    function navigateToDropdown(target) {
        navHistory.push(currentNavLevel);
        showNav(target);
    }

    function navigateBack() {
        if (navHistory.length > 1) {
            const previousLevel = navHistory.pop();
            showNav(previousLevel);
        } else {
            showNav('main');
        }
    }

    // Initialize navigation
    function initNavigation() {
        // Set up dropdown triggers
        document.querySelectorAll('.dropdown-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                navigateToDropdown(target);
            });
        });

        // Set up back buttons
        document.querySelectorAll('.back-to-main').forEach(button => {
            button.addEventListener('click', function() {
                const target = this.getAttribute('data-back');
                if (target === 'main') {
                    showNav('main');
                    navHistory.length = 1; // Reset history
                } else {
                    navigateToDropdown(target);
                }
            });
        });

        // Show appropriate nav based on current page
        const currentPath = window.location.pathname;
        
        // Check if we're on a dropdown page and show the appropriate menu
        {% for link in site.navigation %}
            {% if link.dropdown %}
                {% for sublink in link.dropdown %}
                    {% assign sublink_url = sublink.url | relative_url %}
                    {% if page.url == sublink_url %}
                        navigateToDropdown('{{ link.title | slugify }}');
                    {% endif %}
                    
                    {% if sublink.dropdown %}
                        {% for subsublink in sublink.dropdown %}
                            {% assign subsublink_url = subsublink.url | relative_url %}
                            {% if page.url == subsublink_url %}
                                navigateToDropdown('{{ link.title | slugify }}-{{ sublink.title | slugify }}');
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    }

    // Fix for active state - ensure only current page is active
    function fixActiveStates() {
        const currentPath = window.location.pathname;
        const homeLink = document.querySelector('.nav-link[href="/"]');
        
        // Remove active class from home if we're not on home page
        if (homeLink && currentPath !== '/' && currentPath !== '/index.html') {
            homeLink.classList.remove('active');
        }
        
        // Ensure only one active item at a time
        const allNavLinks = document.querySelectorAll('.nav-link');
        let activeFound = false;
        
        allNavLinks.forEach(link => {
            if (link.classList.contains('active') && activeFound) {
                link.classList.remove('active');
            } else if (link.classList.contains('active')) {
                activeFound = true;
            }
        });
    }

    // Search functionality
    const searchToggle = document.getElementById('searchToggle');
    const searchOverlay = document.getElementById('searchOverlay');
    const searchClose = document.getElementById('searchClose');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    let lunrIndex = null;
    let searchData = {};

    // Initialize search
    function initSearch() {
        fetch('{{ "/assets/js/search-data.json" | relative_url }}')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                searchData = data;
                
                // Build Lunr index with better configuration for short queries
                lunrIndex = lunr(function() {
                    this.ref('id');
                    this.field('title', { boost: 15 });
                    this.field('content', { boost: 1 });
                    this.field('doc', { boost: 10 });
                    
                    // Add pipeline functions to handle short queries better
                    this.pipeline.remove(lunr.stemmer);
                    this.searchPipeline.remove(lunr.stemmer);
                    
                    for (const id in searchData) {
                        this.add({
                            id: id,
                            title: searchData[id].title || '',
                            content: searchData[id].content || '',
                            doc: searchData[id].doc || ''
                        });
                    }
                });
                
                console.log('Search initialized with', Object.keys(searchData).length, 'pages');
            })
            .catch(error => {
                console.error('Search init failed:', error);
                searchResults.innerHTML = '<div class="search-error"><p>Search temporarily unavailable</p></div>';
            });
    }

    // Search functions
    function openSearch() {
        searchOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        searchInput.focus();
        if (!lunrIndex) initSearch();
    }

    function closeSearch() {
        searchOverlay.classList.remove('active');
        document.body.style.overflow = '';
        searchInput.value = '';
        searchResults.innerHTML = '<div class="search-placeholder"><p>Type here to search</p></div>';
    }

    function performSearch(query) {
        if (!query.trim()) {
            searchResults.innerHTML = '<div class="search-placeholder"><p>Type here to search</p></div>';
            return;
        }
        
        if (!lunrIndex) {
            searchResults.innerHTML = '<div class="search-error"><p>Search index loading...</p></div>';
            return;
        }

        try {
            // Use wildcards for partial matching and handle short queries better
            const searchQuery = query.length < 3 ? `*${query}*` : query;
            const results = lunrIndex.search(searchQuery);
            displayResults(results, query);
        } catch (error) {
            console.error('Search error:', error);
            // Fallback to simple client-side search
            fallbackSearch(query);
        }
    }

    function fallbackSearch(query) {
        const results = [];
        const queryLower = query.toLowerCase();
        
        for (const id in searchData) {
            const item = searchData[id];
            const title = item.title ? item.title.toLowerCase() : '';
            const content = item.content ? item.content.toLowerCase() : '';
            const doc = item.doc ? item.doc.toLowerCase() : '';
            
            if (title.includes(queryLower) || content.includes(queryLower) || doc.includes(queryLower)) {
                results.push({ ref: id, score: 1 });
            }
        }
        
        // Sort by relevance (title matches first)
        results.sort((a, b) => {
            const itemA = searchData[a.ref];
            const itemB = searchData[b.ref];
            const titleMatchA = itemA.title.toLowerCase().includes(queryLower);
            const titleMatchB = itemB.title.toLowerCase().includes(queryLower);
            
            if (titleMatchA && !titleMatchB) return -1;
            if (!titleMatchA && titleMatchB) return 1;
            return 0;
        });
        
        displayResults(results, query);
    }

    function displayResults(results, query) {
        if (results.length === 0) {
            searchResults.innerHTML = `<div class="search-no-results"><p>No results found for "${query}"</p></div>`;
            return;
        }

        let html = '<div class="search-results-list">';
        results.slice(0, 10).forEach(result => {
            const item = searchData[result.ref];
            if (!item) return;
            
            // Create a better excerpt that highlights the search term
            const excerpt = createExcerpt(item.content, query);
            
            html += `
                <a href="${item.url}" class="search-result-item">
                    <div class="search-result-content">
                        <div class="search-result-title">${highlightText(item.title, query)}</div>
                        <div class="search-result-excerpt">${excerpt}</div>
                        <div class="search-result-url">${item.relUrl}</div>
                    </div>
                    <svg class="search-result-arrow" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </a>
            `;
        });
        html += '</div>';
        searchResults.innerHTML = html;
    }

    function createExcerpt(content, query) {
        if (!content) return 'No content available';
        
        const queryLower = query.toLowerCase();
        const contentLower = content.toLowerCase();
        const index = contentLower.indexOf(queryLower);
        
        if (index === -1) {
            return content.substring(0, 150) + '...';
        }
        
        // Show context around the search term
        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 100);
        let excerpt = content.substring(start, end);
        
        if (start > 0) excerpt = '...' + excerpt;
        if (end < content.length) excerpt = excerpt + '...';
        
        return highlightText(excerpt, query);
    }

    function highlightText(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Event listeners with debouncing
    let searchTimeout;
    if (searchToggle) searchToggle.addEventListener('click', openSearch);
    if (searchClose) searchClose.addEventListener('click', closeSearch);
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(e.target.value), 150);
        });
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSearch();
        });
    }
    if (searchOverlay) {
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) closeSearch();
        });
    }

    // Initialize search on page load
    initSearch();

    // Fix active states on page load
    fixActiveStates();

    // Mobile menu functionality
    const hamburger = document.querySelector('.hamburger');
    const nav = document.querySelector('.nav');
    
    if (hamburger) {
        hamburger.addEventListener('click', function() {
            hamburger.classList.toggle('active');
            nav.classList.toggle('active');
            document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
            
            // Reset to main nav when opening mobile menu
            if (nav.classList.contains('active')) {
                showNav('main');
                navHistory.length = 1;
            }
        });
    }
    
    // Close mobile menu when clicking on a regular link (not dropdown trigger)
    document.querySelectorAll('.nav-link[href]').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768 && nav.classList.contains('active')) {
                hamburger.classList.remove('active');
                nav.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });

    // Header scroll effect
    const header = document.querySelector('.header');
    if (header) {
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
    }

    // Dark mode functionality
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme') || 
                            (prefersDarkScheme.matches ? 'dark' : 'light');
        
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        themeToggle.addEventListener('click', toggleTheme);
    }

    // Initialize navigation system
    initNavigation();
});
</script>
