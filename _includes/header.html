<header class="header">
    <div class="container">
        <div class="nav-container">
            <div class="logo">
                <a href="{{ '/' | relative_url }}">
                    {% if site.logo %}
                        <img src="{{ site.logo | relative_url }}" alt="{{ site.title }} Logo">
                    {% endif %}
                    <span>{{ site.title_short | default: site.title }}</span>
                </a>
            </div>
            
            <nav class="nav">
                <!-- Search Icon -->
                <button class="search-toggle" id="searchToggle" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </button>

                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>

                <!-- Navigation Menu -->
                <ul class="nav-menu">
                    {% for link in site.navigation %}
                    {% if link.dropdown %}
                    <li class="nav-item dropdown">
                        <a href="javascript:void(0)" class="nav-link {% if page.url == link.url %}active{% endif %}">
                            {{ link.title }} <span class="dropdown-arrow">â–¼</span>
                        </a>
                        <ul class="dropdown-menu">
                            {% for sublink in link.dropdown %}
                            <li>
                                <a href="{{ sublink.url | relative_url }}">{{ sublink.title }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a href="{{ link.url | relative_url }}" class="nav-link {% if page.url == link.url %}active{% endif %}">
                            {{ link.title }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>
                
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-modal">
            <div class="search-header">
                <div class="search-input-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off">
                    <button class="search-close" id="searchClose" aria-label="Close search">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-placeholder">
                    <p>Type to search documentation</p>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality with Lunr.js
        const searchToggle = document.getElementById('searchToggle');
        const searchOverlay = document.getElementById('searchOverlay');
        const searchClose = document.getElementById('searchClose');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        let lunrIndex = null;
        let searchData = {};

        // Initialize search
        function initSearch() {
            // Load search data
            fetch('{{ "/assets/js/search-data.json" | relative_url }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Search data not found');
                    }
                    return response.json();
                })
                .then(data => {
                    searchData = data;
                    
                    // Build Lunr index
                    lunrIndex = lunr(function() {
                        this.ref('id');
                        this.field('title', { boost: 10 });
                        this.field('content', { boost: 2 });
                        this.field('doc', { boost: 5 });
                        
                        // Add documents to index
                        for (const id in searchData) {
                            this.add({
                                id: id,
                                title: searchData[id].title,
                                content: searchData[id].content,
                                doc: searchData[id].doc
                            });
                        }
                    });
                    
                    console.log('Lunr search initialized with', Object.keys(searchData).length, 'documents');
                })
                .catch(error => {
                    console.error('Failed to load search data:', error);
                    searchResults.innerHTML = '<div class="search-error">Search data not available</div>';
                });
        }

        // Toggle search overlay
        function openSearch() {
            searchOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            searchInput.focus();
        }

        function closeSearch() {
            searchOverlay.classList.remove('active');
            document.body.style.overflow = '';
            searchInput.value = '';
            searchResults.innerHTML = '<div class="search-placeholder"><p>Type to search documentation</p></div>';
        }

        // Perform search with Lunr
        function performSearch(query) {
            if (!query.trim()) {
                searchResults.innerHTML = '<div class="search-placeholder"><p>Type to search documentation</p></div>';
                return;
            }
            
            if (!lunrIndex) {
                searchResults.innerHTML = '<div class="search-error">Search index not loaded yet</div>';
                return;
            }

            try {
                // Perform the search
                const results = lunrIndex.search(query);
                displayResults(results, query);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-error">Search error occurred</div>';
            }
        }

        // Display results
        function displayResults(results, query) {
            if (results.length === 0) {
                searchResults.innerHTML = `
                    <div class="search-no-results">
                        <p>No results found for "${query}"</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">
                            Try different keywords or check for typos.
                        </p>
                    </div>
                `;
                return;
            }

            let html = '<div class="search-results-list">';
            
            results.slice(0, 10).forEach(result => {
                const item = searchData[result.ref];
                if (!item) return;
                
                const title = highlightText(item.title, query);
                const excerpt = getExcerpt(item.content, query, 150);
                
                html += `
                    <a href="${item.url}" class="search-result-item">
                        <div class="search-result-content">
                            <div class="search-result-title">${title}</div>
                            <div class="search-result-excerpt">${excerpt}</div>
                            <div class="search-result-url">${item.relUrl}</div>
                        </div>
                        <svg class="search-result-arrow" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </a>
                `;
            });
            
            html += '</div>';
            searchResults.innerHTML = html;
        }

        // Get excerpt with context around search terms
        function getExcerpt(content, query, length = 150) {
            if (!content) return '';
            
            const searchTerms = query.toLowerCase().split(/\s+/);
            const contentLower = content.toLowerCase();
            
            // Try to find a search term in content
            for (const term of searchTerms) {
                if (term.length < 2) continue;
                
                const index = contentLower.indexOf(term);
                if (index !== -1) {
                    const start = Math.max(0, index - 30);
                    const end = Math.min(content.length, index + term.length + 100);
                    let excerpt = content.substring(start, end);
                    
                    if (start > 0) excerpt = '...' + excerpt;
                    if (end < content.length) excerpt = excerpt + '...';
                    
                    return highlightText(excerpt, query);
                }
            }
            
            // Fallback to beginning of content
            const fallbackExcerpt = content.substring(0, length) + (content.length > length ? '...' : '');
            return highlightText(fallbackExcerpt, query);
        }

        // Highlight matching text
        function highlightText(text, query) {
            if (!query.trim() || !text) return text || '';
            
            const terms = query.split(/\s+/);
            let highlighted = text;
            
            terms.forEach(term => {
                if (term.length < 2) return;
                try {
                    const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
                    highlighted = highlighted.replace(regex, '<mark>$1</mark>');
                } catch (error) {
                    // Skip regex errors for this term
                }
            });
            
            return highlighted;
        }

        // Escape regex special characters
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Event listeners for search
        if (searchToggle) {
            searchToggle.addEventListener('click', openSearch);
        }

        if (searchClose) {
            searchClose.addEventListener('click', closeSearch);
        }

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                performSearch(this.value);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSearch();
                }
                
                // Handle arrow keys for result navigation
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
                    e.preventDefault();
                    navigateResults(e.key);
                }
            });
        }

        // Result navigation with keyboard
        function navigateResults(key) {
            const results = searchResults.querySelectorAll('.search-result-item');
            if (results.length === 0) return;
            
            const currentActive = searchResults.querySelector('.search-result-item.active');
            let newActive = null;
            
            if (key === 'ArrowDown') {
                newActive = currentActive ? 
                    currentActive.nextElementSibling : results[0];
            } else if (key === 'ArrowUp') {
                newActive = currentActive ? 
                    currentActive.previousElementSibling : results[results.length - 1];
            } else if (key === 'Enter' && currentActive) {
                currentActive.click();
                return;
            }
            
            if (currentActive) currentActive.classList.remove('active');
            if (newActive) {
                newActive.classList.add('active');
                newActive.scrollIntoView({ block: 'nearest' });
            }
        }

        // Close overlay when clicking on backdrop
        if (searchOverlay) {
            searchOverlay.addEventListener('click', function(e) {
                if (e.target === searchOverlay) {
                    closeSearch();
                }
            });
        }

        // Initialize search on page load
        initSearch();

        // Your existing JavaScript for mobile nav, dropdowns, etc.
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const dropdowns = document.querySelectorAll('.dropdown');
        
        if (hamburger) {
            hamburger.addEventListener('click', function() {
                hamburger.classList.toggle('active');
                navMenu.classList.toggle('active');
                document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
            });
        }
        
        // Handle dropdowns
        dropdowns.forEach(dropdown => {
            const link = dropdown.querySelector('.nav-link');
            const dropdownMenu = dropdown.querySelector('.dropdown-menu');
            
            dropdown.addEventListener('mouseenter', function() {
                if (window.innerWidth > 768) {
                    dropdownMenu.style.opacity = '1';
                    dropdownMenu.style.visibility = 'visible';
                    dropdownMenu.style.transform = 'translateY(0)';
                }
            });
            
            dropdown.addEventListener('mouseleave', function() {
                if (window.innerWidth > 768) {
                    dropdownMenu.style.opacity = '0';
                    dropdownMenu.style.visibility = 'hidden';
                    dropdownMenu.style.transform = 'translateY(10px)';
                }
            });
            
            link.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    dropdown.classList.toggle('active');
                    
                    dropdowns.forEach(otherDropdown => {
                        if (otherDropdown !== dropdown) {
                            otherDropdown.classList.remove('active');
                        }
                    });
                }
            });
        });
        
        // Header scroll effect
        const header = document.querySelector('.header');
        if (header) {
            window.addEventListener('scroll', () => {
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        }
        
        // Close mobile menu when clicking on a link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    const parentDropdown = link.closest('.dropdown');
                    if (!parentDropdown) {
                        if (hamburger) hamburger.classList.remove('active');
                        if (navMenu) navMenu.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        // Dark mode functionality
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            const currentTheme = localStorage.getItem('theme') || 
                                (prefersDarkScheme.matches ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            }
            
            themeToggle.addEventListener('click', toggleTheme);
        }
    });
</script>
