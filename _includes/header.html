<!-- _includes/header.html -->
<header class="header">
    <div class="container">
        <div class="nav-container">
            <div class="logo">
                <a href="{{ '/' | relative_url }}">
                    {% if site.logo %}
                        <img src="{{ site.logo | relative_url }}" alt="{{ site.title }} Logo">
                    {% endif %}
                    <span>{{ site.title_short | default: site.title }}</span>
                </a>
            </div>
            
            <nav class="nav">
                <!-- Search Icon -->
                <button class="search-toggle" id="searchToggle" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </button>

                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg class="moon-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>

                <!-- Navigation Menu -->
                <ul class="nav-menu" id="navMenu">
                    {% for item in site.navigation %}
                        {% assign item_key = item[0] %}
                        {% assign item_value = item[1] %}
                        
                        {% if item_value.url %}
                            <!-- Simple link item -->
                            <li class="nav-item">
                                <a href="{{ item_value.url | relative_url }}" class="nav-link {% if page.url == item_value.url %}active{% endif %}">
                                    {{ item_key }}
                                </a>
                            </li>
                        {% elsif item_value.first %}
                            <!-- Dropdown item with nested items -->
                            <li class="nav-item dropdown" data-dropdown>
                                <button class="nav-link dropdown-toggle" data-dropdown-button type="button">
                                    {{ item_key }}
                                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.646 6.646a.5.5 0 01.708 0L8 9.293l2.646-2.647a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 010-.708z"/>
                                    </svg>
                                </button>
                                <div class="dropdown-menu" data-dropdown-menu>
                                    {% for nested_item in item_value %}
                                        {% if nested_item.first %}
                                            <!-- Nested dropdown section -->
                                            {% assign nested_key = nested_item[0] %}
                                            {% assign nested_value = nested_item[1] %}
                                            
                                            <div class="dropdown-section">
                                                <div class="dropdown-header">{{ nested_key }}</div>
                                                {% for sub_item in nested_value %}
                                                    {% if sub_item.first %}
                                                        <!-- Third level items -->
                                                        {% for sub_sub_item in sub_item %}
                                                            <a href="{{ sub_sub_item[1] | relative_url }}" class="dropdown-link">
                                                                {{ sub_sub_item[0] }}
                                                            </a>
                                                        {% endfor %}
                                                    {% else %}
                                                        <!-- Second level items -->
                                                        <a href="{{ sub_item[1] | relative_url }}" class="dropdown-link">
                                                            {{ sub_item[0] }}
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <!-- Direct links in dropdown -->
                                            <a href="{{ nested_item[1] | relative_url }}" class="dropdown-link">
                                                {{ nested_item[0] }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                
                <div class="hamburger" id="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-modal">
            <div class="search-header">
                <div class="search-input-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off">
                    <button class="search-close" id="searchClose" aria-label="Close search">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-placeholder">
                    <p>Type here to search</p>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mobile menu functionality
    const hamburger = document.getElementById('hamburger');
    const navMenu = document.getElementById('navMenu');
    
    if (hamburger && navMenu) {
        hamburger.addEventListener('click', function() {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
        });
    }
    
    // Dropdown functionality
    const dropdowns = document.querySelectorAll('[data-dropdown]');
    
    // Initialize dropdowns
    dropdowns.forEach(dropdown => {
        const button = dropdown.querySelector('[data-dropdown-button]');
        const menu = dropdown.querySelector('[data-dropdown-menu]');
        
        // Desktop hover functionality
        if (window.innerWidth > 768) {
            dropdown.addEventListener('mouseenter', function() {
                showDropdown(menu);
            });
            
            dropdown.addEventListener('mouseleave', function() {
                hideDropdown(menu);
            });
        }
        
        // Mobile click functionality
        button.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                e.preventDefault();
                e.stopPropagation();
                
                const isActive = menu.style.maxHeight && menu.style.maxHeight !== '0px';
                
                // Close all other dropdowns
                dropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('[data-dropdown-menu]');
                        hideDropdown(otherMenu);
                    }
                });
                
                // Toggle current dropdown
                if (isActive) {
                    hideDropdown(menu);
                } else {
                    showDropdown(menu);
                }
            }
        });
    });
    
    // Helper functions for dropdowns
    function showDropdown(menu) {
        if (window.innerWidth > 768) {
            menu.style.opacity = '1';
            menu.style.visibility = 'visible';
            menu.style.transform = 'translateY(0)';
        } else {
            menu.style.maxHeight = menu.scrollHeight + 'px';
            menu.style.opacity = '1';
        }
    }
    
    function hideDropdown(menu) {
        if (window.innerWidth > 768) {
            menu.style.opacity = '0';
            menu.style.visibility = 'hidden';
            menu.style.transform = 'translateY(-8px)';
        } else {
            menu.style.maxHeight = '0';
            menu.style.opacity = '0';
        }
    }
    
    // Close dropdowns when clicking outside (desktop)
    document.addEventListener('click', function(e) {
        if (window.innerWidth > 768) {
            if (!e.target.closest('[data-dropdown]')) {
                dropdowns.forEach(dropdown => {
                    const menu = dropdown.querySelector('[data-dropdown-menu]');
                    hideDropdown(menu);
                });
            }
        }
    });
    
    // Close mobile menu when clicking on regular links
    document.querySelectorAll('.nav-link:not([data-dropdown-button]), .dropdown-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                // Close mobile menu
                if (hamburger) hamburger.classList.remove('active');
                if (navMenu) navMenu.classList.remove('active');
                document.body.style.overflow = '';
                
                // Close all dropdowns
                dropdowns.forEach(dropdown => {
                    const menu = dropdown.querySelector('[data-dropdown-menu]');
                    hideDropdown(menu);
                });
            }
        });
    });
    
    // Search functionality
    const searchToggle = document.getElementById('searchToggle');
    const searchOverlay = document.getElementById('searchOverlay');
    const searchClose = document.getElementById('searchClose');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    function openSearch() {
        if (searchOverlay) {
            searchOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            if (searchInput) searchInput.focus();
        }
    }
    
    function closeSearch() {
        if (searchOverlay) {
            searchOverlay.classList.remove('active');
            document.body.style.overflow = '';
            if (searchInput) searchInput.value = '';
            if (searchResults) searchResults.innerHTML = '<div class="search-placeholder"><p>Type here to search</p></div>';
        }
    }
    
    // Event listeners for search
    if (searchToggle) searchToggle.addEventListener('click', openSearch);
    if (searchClose) searchClose.addEventListener('click', closeSearch);
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSearch();
        });
    }
    if (searchOverlay) {
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) closeSearch();
        });
    }
    
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme') || 
                            (prefersDarkScheme.matches ? 'dark' : 'light');
        
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        themeToggle.addEventListener('click', toggleTheme);
    }
    
    // Handle window resize
    window.addEventListener('resize', function() {
        // Reset dropdown states on resize to desktop
        if (window.innerWidth > 768) {
            if (navMenu) navMenu.classList.remove('active');
            if (hamburger) hamburger.classList.remove('active');
            document.body.style.overflow = '';
            
            dropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('[data-dropdown-menu]');
                menu.style.maxHeight = '';
                menu.style.opacity = '';
                menu.style.visibility = 'hidden';
                menu.style.transform = 'translateY(-8px)';
            });
        }
    });
});
</script>
